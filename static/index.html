<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë°°ë„ˆ ì œì‘ ì„œë¹„ìŠ¤</title>
  <style>
    :root {
      --theme-color: #ffeb3b;
      --blur: 16px;
      --gf: rgba(255,255,255,0.08);
      --gf-hover: rgba(255,255,255,0.13);
      --gb1: rgba(255,255,255,0.28);
      --gb2: rgba(255,255,255,0.08);
      --tp: rgba(255,255,255,0.95);
      --ts: rgba(255,255,255,0.55);
      --accent: #ffeb3b;
      --r: 14px;
      --bg: #1c1f2e;
      --font: "Inter","Segoe UI",sans-serif;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:var(--font); min-height:100vh; background:var(--bg); display:flex; justify-content:center; align-items:center; padding:20px; }
    .tablet-container { width:768px; max-width:100%; min-height:90vh; border-radius:calc(var(--r)*1.5); overflow:hidden; position:relative; background:rgba(255,255,255,0.06); backdrop-filter:blur(var(--blur)); -webkit-backdrop-filter:blur(var(--blur)); border-top:1px solid var(--gb1); border-left:1px solid var(--gb1); border-right:1px solid var(--gb2); border-bottom:1px solid var(--gb2); box-shadow:0 8px 48px rgba(0,0,0,0.5),inset 0 1px 0 rgba(255,255,255,0.1); }
    .header { padding:30px 40px 26px; border-bottom:1px solid var(--gb2); background:rgba(255,235,59,0.05); display:flex; justify-content:space-between; align-items:center; }
    .header h1 { font-size:26px; font-weight:700; color:var(--tp); letter-spacing:-0.5px; }
    .header h1 span { color:var(--accent); }
    .token-status { display:flex; align-items:center; gap:8px; font-size:12px; color:var(--ts); cursor:pointer; padding:6px 12px; background:var(--gf); border-radius:8px; border:1px solid var(--gb2); transition:all 0.2s; }
    .token-status:hover { background:var(--gf-hover); }
    .token-dot { width:7px; height:7px; border-radius:50%; background:#ff4444; }
    .token-dot.ok { background:#44ff88; }
    .content { padding:30px 40px 40px; overflow-y:auto; }
    .form-group { margin-bottom:26px; }
    .form-label { display:block; font-size:11px; font-weight:600; color:var(--ts); letter-spacing:1px; text-transform:uppercase; margin-bottom:10px; }
    .required { color:var(--accent); margin-left:3px; }
    .optional { color:rgba(255,255,255,0.3); margin-left:4px; font-weight:400; text-transform:none; letter-spacing:0; font-size:12px; }
    input[type="text"],input[type="number"],input[type="password"],textarea { width:100%; padding:11px 15px; background:var(--gf); border-top:1px solid var(--gb1); border-left:1px solid var(--gb1); border-right:1px solid var(--gb2); border-bottom:1px solid var(--gb2); border-radius:var(--r); font-size:14px; font-family:var(--font); color:var(--tp); transition:all 0.25s ease-out; outline:none; }
    input::placeholder,textarea::placeholder { color:var(--ts); }
    input:focus,textarea:focus { background:var(--gf-hover); border-top-color:rgba(255,235,59,0.5); border-left-color:rgba(255,235,59,0.5); box-shadow:0 0 0 2px rgba(255,235,59,0.12); }
    textarea { resize:vertical; min-height:88px; }
    .size-input-group { display:flex; align-items:center; gap:10px; margin-bottom:10px; }
    .size-input-group input { width:100px; }
    .size-input-group span { color:var(--ts); font-size:14px; }
    .quick-size-buttons { display:flex; gap:7px; flex-wrap:wrap; }
    .quick-size-btn { padding:6px 13px; background:var(--gf); border-top:1px solid var(--gb1); border-left:1px solid var(--gb1); border-right:1px solid transparent; border-bottom:1px solid transparent; border-radius:8px; font-size:12px; font-family:var(--font); color:var(--ts); cursor:pointer; transition:all 0.2s ease-out; }
    .quick-size-btn:hover { background:rgba(255,235,59,0.12); color:var(--accent); border-top-color:rgba(255,235,59,0.35); border-left-color:rgba(255,235,59,0.35); }
    .btn { padding:11px 20px; border-radius:var(--r); font-size:14px; font-weight:600; font-family:var(--font); cursor:pointer; transition:all 0.25s ease-out; border:none; }
    .btn-glass { background:var(--gf); border-top:1px solid var(--gb1); border-left:1px solid var(--gb1); border-right:1px solid var(--gb2); border-bottom:1px solid var(--gb2); color:var(--tp); }
    .btn-glass:hover { background:var(--gf-hover); }
    .btn-primary { background:var(--accent); color:#1a1200; width:100%; padding:15px; font-size:15px; margin-top:6px; box-shadow:0 4px 20px rgba(255,235,59,0.25); }
    .btn-primary:hover { background:#ffe000; transform:translateY(-1px); box-shadow:0 6px 24px rgba(255,235,59,0.35); }
    .btn-primary:disabled { opacity:0.4; cursor:not-allowed; transform:none; }
    .file-upload-label { display:block; border:1.5px dashed rgba(255,255,255,0.22); border-radius:var(--r); padding:36px 20px; text-align:center; cursor:pointer; transition:all 0.25s ease-out; width:100%; }
    .file-upload-label:hover { border-color:rgba(255,235,59,0.45); background:rgba(255,235,59,0.04); }
    .file-upload-label input { display:none; }
    .upload-icon { font-size:28px; margin-bottom:10px; }
    .upload-text { font-size:14px; color:var(--ts); }
    .upload-sub { font-size:12px; color:rgba(255,255,255,0.28); margin-top:6px; }
    #uploaded-files { margin-top:12px; }
    .file-item { display:inline-block; padding:6px 13px; background:var(--gf); border-top:1px solid var(--gb1); border-radius:8px; margin:3px; font-size:12px; color:var(--ts); }

    /* í† í° ì„¤ì • ëª¨ë‹¬ */
    .modal-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); backdrop-filter:blur(8px); z-index:100; justify-content:center; align-items:center; }
    .modal-overlay.open { display:flex; }
    .modal { width:480px; max-width:90%; background:#1e2235; border-top:1px solid var(--gb1); border-left:1px solid var(--gb1); border-right:1px solid var(--gb2); border-bottom:1px solid var(--gb2); border-radius:calc(var(--r)*1.5); padding:32px; }
    .modal h3 { font-size:18px; font-weight:700; color:var(--tp); margin-bottom:6px; }
    .modal p { font-size:13px; color:var(--ts); margin-bottom:24px; line-height:1.6; }
    .modal p a { color:var(--accent); text-decoration:none; }
    .modal-actions { display:flex; gap:8px; margin-top:20px; }
    .token-input-wrap { position:relative; }
    .token-input-wrap input { padding-right:80px; }
    .token-toggle { position:absolute; right:12px; top:50%; transform:translateY(-50%); font-size:11px; color:var(--ts); cursor:pointer; background:var(--gf); padding:3px 8px; border-radius:6px; border:1px solid var(--gb2); }
    .token-user-info { margin-top:10px; padding:10px 14px; background:rgba(68,255,136,0.08); border:1px solid rgba(68,255,136,0.2); border-radius:8px; font-size:13px; color:#44ff88; display:none; }

    /* ì±„íŒ… í™”ë©´ */
    #chat-screen { display:none; height:90vh; flex-direction:column; }
    .chat-header { padding:20px 40px; border-bottom:1px solid var(--gb2); background:rgba(255,235,59,0.04); display:flex; align-items:center; gap:12px; }
    .chat-header h2 { font-size:17px; font-weight:700; color:var(--tp); flex:1; }
    .back-btn { width:30px; height:30px; border-radius:50%; background:var(--gf); border-top:1px solid var(--gb1); border-left:1px solid var(--gb1); border-right:1px solid transparent; border-bottom:1px solid transparent; color:var(--ts); font-size:14px; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all 0.2s ease-out; flex-shrink:0; }
    .back-btn:hover { background:var(--gf-hover); color:var(--tp); }
    .chat-messages { flex:1; overflow-y:auto; padding:28px 40px; display:flex; flex-direction:column; gap:14px; }
    .chat-messages::-webkit-scrollbar { width:3px; }
    .chat-messages::-webkit-scrollbar-thumb { background:rgba(255,255,255,0.12); border-radius:2px; }
    .message { display:flex; }
    .message.user { justify-content:flex-end; }
    .message-content { max-width:75%; padding:13px 17px; border-radius:var(--r); font-size:14px; line-height:1.6; }
    .message.assistant .message-content { background:var(--gf); border-top:1px solid var(--gb1); border-left:1px solid var(--gb1); border-right:1px solid var(--gb2); border-bottom:1px solid var(--gb2); color:var(--tp); }
    .message.user .message-content { background:rgba(255,235,59,0.88); color:#1a1200; font-weight:500; }
    .figma-link { display:inline-flex; align-items:center; gap:6px; margin-top:12px; padding:10px 16px; background:rgba(255,235,59,0.12); border:1px solid rgba(255,235,59,0.3); border-radius:10px; color:var(--accent); font-size:13px; font-weight:600; text-decoration:none; transition:all 0.2s; }
    .figma-link:hover { background:rgba(255,235,59,0.2); }
    .chat-input-area { padding:18px 40px; border-top:1px solid var(--gb2); background:rgba(255,235,59,0.03); }
    .chat-input-group { display:flex; gap:8px; }
    .chat-input-group input { flex:1; }
    .chat-send-btn { padding:11px 20px; background:var(--accent); color:#1a1200; border:none; border-radius:var(--r); font-size:14px; font-weight:600; font-family:var(--font); cursor:pointer; transition:all 0.2s ease-out; white-space:nowrap; }
    .chat-send-btn:hover { background:#ffe000; }
    .new-banner-btn { margin-top:10px; width:100%; background:transparent; border:1px solid var(--gb2); border-radius:var(--r); color:var(--ts); padding:9px; font-size:13px; font-family:var(--font); cursor:pointer; transition:all 0.2s ease-out; }
    .new-banner-btn:hover { background:var(--gf); color:var(--tp); }
  </style>
</head>
<body>
<div class="tablet-container">
  <!-- ì´ˆê¸° í™”ë©´ -->
  <div id="initial-screen">
    <div class="header">
      <h1>ë°°ë„ˆ <span>ì œì‘</span> ì„œë¹„ìŠ¤</h1>
      <div class="token-status" onclick="openTokenModal()">
        <div class="token-dot" id="token-dot"></div>
        <span id="token-label">Figma ì—°ê²° ì•ˆë¨</span>
      </div>
    </div>
    <div class="content">
      <div class="form-group">
        <label class="form-label">ë°°ë„ˆ ì‚¬ì´ì¦ˆ <span class="required">*</span></label>
        <div class="size-input-group">
          <input type="number" id="width" placeholder="ê°€ë¡œ">
          <span>Ã—</span>
          <input type="number" id="height" placeholder="ì„¸ë¡œ">
          <span>px</span>
        </div>
        <div class="quick-size-buttons">
          <button class="quick-size-btn" onclick="setSize(1080,1080)">1080Ã—1080</button>
          <button class="quick-size-btn" onclick="setSize(1200,628)">1200Ã—628</button>
          <button class="quick-size-btn" onclick="setSize(728,90)">728Ã—90</button>
          <button class="quick-size-btn" onclick="setSize(300,250)">300Ã—250</button>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">ë°°ë„ˆ ìš©ë„ <span class="required">*</span></label>
        <input type="text" id="purpose" placeholder="ì˜ˆ: ì¸ìŠ¤íƒ€ê·¸ë¨ í”¼ë“œ ê´‘ê³ ">
      </div>
      <div class="form-group">
        <label class="form-label">ì¶”ê°€ ìš”êµ¬ì‚¬í•­ <span class="optional">(ì„ íƒ)</span></label>
        <textarea id="requirements" placeholder="ë°°ë„ˆì— í¬í•¨ë˜ì–´ì•¼ í•  ìš”ì†Œ, ë¶„ìœ„ê¸°, ìŠ¤íƒ€ì¼ ë“±ì„ ììœ ë¡­ê²Œ ì…ë ¥í•˜ì„¸ìš”"></textarea>
      </div>
      <div class="form-group">
        <label class="form-label">ë ˆí¼ëŸ°ìŠ¤ ì´ë¯¸ì§€ <span class="optional">(ì„ íƒ)</span></label>
        <label class="file-upload-label" for="file-input">
          <div class="upload-icon">ğŸ“</div>
          <div class="upload-text">í´ë¦­í•˜ì—¬ íŒŒì¼ ì„ íƒ</div>
          <div class="upload-sub">ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥ (ìµœëŒ€ 15ê°œ)</div>
          <input type="file" id="file-input" multiple accept="image/*" onchange="handleFileUpload(event)">
        </label>
        <div id="uploaded-files"></div>
      </div>
      <button class="btn btn-primary" id="generate-btn" onclick="generateBanner()">ë°°ë„ˆ ìƒì„±í•˜ê¸°</button>
    </div>
  </div>

  <!-- ì±„íŒ… í™”ë©´ -->
  <div id="chat-screen">
    <div class="chat-header">
      <button class="back-btn" onclick="resetToInitial()">â†</button>
      <h2>ë°°ë„ˆ ìˆ˜ì •í•˜ê¸°</h2>
    </div>
    <div class="chat-messages" id="chat-messages"></div>
    <div class="chat-input-area">
      <div class="chat-input-group">
        <input type="text" id="chat-input" placeholder="ìˆ˜ì • ìš”ì²­ì„ ì…ë ¥í•˜ì„¸ìš”...">
        <button class="chat-send-btn" onclick="sendMessage()">ì „ì†¡</button>
      </div>
      <button class="new-banner-btn" onclick="resetToInitial()">ìƒˆ ë°°ë„ˆ ë§Œë“¤ê¸°</button>
    </div>
  </div>
</div>

<!-- Figma í† í° ëª¨ë‹¬ -->
<div class="modal-overlay" id="token-modal">
  <div class="modal">
    <h3>Figma í† í° ì„¤ì •</h3>
    <p>
      Figma â†’ í”„ë¡œí•„ â†’ Settings â†’ Security â†’ Personal access tokensì—ì„œ ë°œê¸‰.<br>
      ìŠ¤ì½”í”„: <strong style="color:var(--accent)">File content: Read and Write</strong> ì„ íƒ.<br>
      <a href="https://www.figma.com/settings" target="_blank">Figma ì„¤ì • ë°”ë¡œê°€ê¸° â†’</a>
    </p>
    <div class="token-input-wrap">
      <input type="password" id="token-input" placeholder="figd_..." oninput="clearTokenStatus()">
      <span class="token-toggle" onclick="toggleTokenVis()">ë³´ê¸°</span>
    </div>
    <div class="token-user-info" id="token-user-info"></div>
    <div class="modal-actions">
      <button class="btn btn-primary" style="margin-top:0; flex:1" onclick="verifyToken()">í™•ì¸ ë° ì €ì¥</button>
      <button class="btn btn-glass" onclick="closeTokenModal()">ë‹«ê¸°</button>
    </div>
  </div>
</div>

<script>
  // í† í° ê´€ë¦¬
  function getFigmaToken() { return localStorage.getItem('figma_token') || ''; }
  function setFigmaToken(t) { localStorage.setItem('figma_token', t); }
  function getFigmaFileKey() { return localStorage.getItem('figma_file_key') || ''; }
  function setFigmaFileKey(k) { localStorage.setItem('figma_file_key', k); }

  function updateTokenUI(name) {
    const dot = document.getElementById('token-dot');
    const label = document.getElementById('token-label');
    const btn = document.getElementById('generate-btn');
    if (name) {
      dot.classList.add('ok');
      label.textContent = name;
      btn.disabled = false;
    } else {
      dot.classList.remove('ok');
      label.textContent = 'Figma ì—°ê²° ì•ˆë¨';
      btn.disabled = true;
    }
  }

  function openTokenModal() {
    document.getElementById('token-modal').classList.add('open');
    const t = getFigmaToken();
    if (t) document.getElementById('token-input').value = t;
  }
  function closeTokenModal() {
    document.getElementById('token-modal').classList.remove('open');
  }
  function toggleTokenVis() {
    const inp = document.getElementById('token-input');
    inp.type = inp.type === 'password' ? 'text' : 'password';
  }
  function clearTokenStatus() {
    document.getElementById('token-user-info').style.display = 'none';
  }

  async function verifyToken() {
    const token = document.getElementById('token-input').value.trim();
    if (!token) return alert('í† í°ì„ ì…ë ¥í•˜ì„¸ìš”');
    const info = document.getElementById('token-user-info');
    info.style.display = 'none';
    info.textContent = 'í™•ì¸ ì¤‘...';
    info.style.display = 'block';
    info.style.color = 'var(--ts)';

    try {
      const res = await fetch('/api/figma/verify', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({token})
      });
      const data = await res.json();
      if (data.status === 'success') {
        setFigmaToken(token);
        localStorage.setItem('figma_user', data.name);
        info.textContent = `âœ“ ì—°ê²°ë¨: ${data.name} (${data.email})`;
        info.style.color = '#44ff88';
        updateTokenUI(data.name);
        setTimeout(closeTokenModal, 1200);
      } else {
        info.textContent = 'âœ— ' + data.error;
        info.style.color = '#ff6b6b';
      }
    } catch(e) {
      info.textContent = 'âœ— ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜';
      info.style.color = '#ff6b6b';
    }
  }

  // ì´ˆê¸° í† í° ìƒíƒœ ë³µì›
  window.addEventListener('DOMContentLoaded', () => {
    const name = localStorage.getItem('figma_user');
    const token = getFigmaToken();
    if (name && token) updateTokenUI(name);
    else {
      document.getElementById('generate-btn').disabled = true;
      setTimeout(openTokenModal, 500);
    }
    document.getElementById('chat-input')?.addEventListener('keypress', e => { if(e.key==='Enter') sendMessage(); });
  });

  // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ë‹«ê¸°
  document.getElementById('token-modal').addEventListener('click', e => {
    if (e.target === e.currentTarget) closeTokenModal();
  });

  function setSize(w, h) { document.getElementById('width').value=w; document.getElementById('height').value=h; }
  function handleFileUpload(e) {
    if (e.target.files.length > 15) return alert('ìµœëŒ€ 15ê°œê¹Œì§€ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤');
    document.getElementById('uploaded-files').innerHTML =
      Array.from(e.target.files).map(f=>`<div class="file-item">ğŸ“„ ${f.name}</div>`).join('');
  }

  let currentContext = '';

  function addMessage(role, html) {
    const msgs = document.getElementById('chat-messages');
    msgs.innerHTML += `<div class="message ${role}"><div class="message-content">${html}</div></div>`;
    msgs.scrollTop = msgs.scrollHeight;
  }

  async function generateBanner() {
    const w = document.getElementById('width').value;
    const h = document.getElementById('height').value;
    const p = document.getElementById('purpose').value;
    const r = document.getElementById('requirements').value;
    const token = getFigmaToken();

    if (!w||!h||!p) return alert('í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”');
    if (!token) return openTokenModal();

    document.getElementById('initial-screen').style.display = 'none';
    document.getElementById('chat-screen').style.display = 'flex';
    document.getElementById('chat-messages').innerHTML = '';
    addMessage('assistant', 'ë””ìì¸ ìŠ¤í™ ìƒì„± ì¤‘... â³');

    try {
      // 1ë‹¨ê³„: Geminië¡œ ë””ìì¸ ìŠ¤í™ ìƒì„±
      const genRes = await fetch('/api/generate', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({width:w, height:h, purpose:p, requirements:r})
      });
      const genData = await genRes.json();
      if (genData.status !== 'success') throw new Error(genData.error || 'ìŠ¤í™ ìƒì„± ì‹¤íŒ¨');

      document.getElementById('chat-messages').innerHTML = '';
      addMessage('assistant', 'Figma íŒŒì¼ ìƒì„± ì¤‘... â³');

      // 2ë‹¨ê³„: Figmaì— ë°°ë„ˆ ìƒì„±
      const figmaRes = await fetch('/api/figma/create', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({figma_token: token, design_spec: genData.design_spec, file_key: getFigmaFileKey()})
      });
      const figmaData = await figmaRes.json();
      if (figmaData.status !== 'success') throw new Error(figmaData.error || 'Figma ìƒì„± ì‹¤íŒ¨');

      setFigmaFileKey(figmaData.file_key);
      currentContext = `ì‚¬ì´ì¦ˆ: ${w}x${h}px, ìš©ë„: ${p}, ë””ìì¸ ë¸Œë¦¬í”„: ${genData.design_brief}`;
      document.getElementById('chat-messages').innerHTML = '';
      addMessage('assistant', `
        <strong>${w}Ã—${h}px ${p} ë°°ë„ˆê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤</strong><br><br>
        ${genData.design_brief}<br><br>
        <a class="figma-link" href="${figmaData.url}" target="_blank">
          âœ¦ Figmaì—ì„œ ì—´ê¸° â†’
        </a><br><br>
        ìˆ˜ì •ì´ í•„ìš”í•˜ì‹œë©´ ì•„ë˜ì— ì…ë ¥í•´ì£¼ì„¸ìš”.
      `);
    } catch(e) {
      document.getElementById('chat-messages').innerHTML = '';
      addMessage('assistant', `ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${e.message}`);
    }
  }

  async function sendMessage() {
    const inp = document.getElementById('chat-input');
    const msg = inp.value.trim();
    if (!msg) return;
    inp.value = '';
    addMessage('user', msg);
    addMessage('assistant', 'ìˆ˜ì • ìš”ì²­ì„ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤... â³');

    try {
      const res = await fetch('/api/chat', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({message:msg, context:currentContext})
      });
      const data = await res.json();
      if (data.status !== 'success') throw new Error(data.error || 'ì‘ë‹µ ì‹¤íŒ¨');
      const msgs = document.getElementById('chat-messages');
      msgs.lastElementChild.remove();
      addMessage('assistant', data.reply.replace(/\n/g,'<br>'));
    } catch(e) {
      const msgs = document.getElementById('chat-messages');
      msgs.lastElementChild.remove();
      addMessage('assistant', `ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${e.message}`);
    }
  }

  function resetToInitial() {
    if (!confirm('ìƒˆ ë°°ë„ˆë¥¼ ë§Œë“œì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    document.getElementById('chat-screen').style.display = 'none';
    document.getElementById('initial-screen').style.display = 'block';
    document.getElementById('chat-messages').innerHTML = '';
  }
</script>
</body>
</html>